<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>

  <title>Rose Advanced Tutorial: namespace triggers</title>
  <meta name="author" content="Rose Team, Met Office, UK" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="defaultView" content="outline" />
  <meta name="controlVis" content="visible" />
  <link rel="stylesheet" href="S5/slides.css" type="text/css" media=
  "projection" id="slideProj" />
  <link rel="stylesheet" href="S5/outline-rose.css" type="text/css" media=
  "screen" id="outlineStyle" />
  <link rel="stylesheet" href="S5/opera.css" type="text/css" media="projection"
  id="operaFix" />
  <link rel="stylesheet" type="text/css" href=
  "google-code-prettify/prettify.css" />
  <link rel="icon" href="rose-icon.png" type="image/png" />
  <link rel="shortcut icon" href="rose-icon.png" type="image/png" />
  <script src="S5/slides.js" type="text/javascript">
</script>
  <script type="text/javascript" src="jquery.min.js">
</script>
  <script type="text/javascript" src="google-code-prettify/prettify.js">
</script>
  <script type="text/javascript" src="prettify-rose-conf.js">
</script>
  <script type="text/javascript" src="prettify-cylc-suite-rc.js">
</script>
  <script type="text/javascript" src="rose-doc.js">
</script>
  <script type="text/javascript" src="rose-version.js">
</script>
</head>

<body>
  <div class="header-footer" id="body-header">
    <address>
      &copy; British Crown Copyright 2012-3 <a href=
      "http://www.metoffice.gov.uk">Met Office</a>. See <a href=
      "rose-terms-of-use.html">Terms of Use</a>.<br />
      This document is released under the <a href=
      "http://www.nationalarchives.gov.uk/doc/open-government-licence/" rel=
      "license">Open Government Licence</a>.<br />
      <span id="rose-version"></span>
    </address>

    <div class="rose-link">
      <img id="rose-icon" src="rose-icon.png" alt="Rose" />

      <p><a id="doc-home-link" href="." name="doc-home-link">Rose
      Documentation</a></p>
    </div>

    <div id="currentSlide">
      <!-- DO NOT EDIT -->
    </div>

    <div id="controls">
      <!-- DO NOT EDIT -->
    </div>

    <div class="header-footer" id="footer"></div>
  </div>

  <div id="body-main" class="presentation">
    <div class="slide">
      <h1>Rose Advanced Tutorial: namespace triggers</h1>
    </div>

    <div class="handout" id="content"></div>

    <div class="slide">
      <h2 id="intro">Introduction</h2>

      <p>This tutorial walks you through using namespace triggers.</p>

      <p>Namespace triggers allow you to build dependencies based on sets of 
      tasks sharing the same namespace, sometimes referred to as "families".
      </p>
      
    </div>

    <div class="slide">
      <h2 id="purpose">Purpose</h2>

      <p>Namespace triggers are used to specify a condition to be met by a set 
      of tasks in a particular namespace that will trigger the next entry in 
      the dependencies graph.</p>

      <p>Like regular task based triggers, namespace triggers can depend on the
      success or failure of tasks. However, because a namespace can contain 
      multiple tasks, you need to specify whether you are concerned with 
      <em>all</em> or <em>any</em> of the tasks in that namespace reaching the 
      desired state.</p>
    </div>

    <div class="slide">
      <h2 id="example-task">Example</h2>

      <p>Create a <a href="rose-rug-brief-tour#cli">new suite</a> (or just a
      new directory somewhere - e.g. in your homespace) containing a blank
      <samp>rose-suite.conf</samp> and a <samp>suite.rc</samp> file that looks
      like this:</p>
      <pre class="prettyprint lang-cylc">
[scheduling]
    [[dependencies]]
        graph = "visit_mine => MINERS"
[runtime]
    [[root]]
        [[[event hooks]]]
            succeeded handler = "rose suite-hook"
            failed handler = "rose suite-hook"
    [[visit_mine]]
        command scripting = "sleep 5; echo 'off to work we go'"
</pre>
    </div>

    <div class="slide">
      <h3 class="alwayshidden">Example (2)</h3>
      <pre class="prettyprint lang-cylc">
    [[MINERS]]
        command scripting = """sleep 5; 
                                if (($RANDOM % 2)); then 
                                    echo 'Diamonds!'; true;
                                else 
                                    echo 'Nothing...'; false;
                                fi
                            """
    [[doc, grumpy, sleepy, happy, bashful, sneezy, dopey]]
        inherit = MINERS
</pre>
    </div>

    <div class="slide">
      <h2 id="description">Description</h2>

      <p>You have now created a suite that:</p>

      <ul>
        <li>contains a <samp>visit_mine</samp> task that sleeps for 5 seconds
        then outputs a message.</li>

        <li>contains a <samp>MINERS</samp> namespace (family) with a command in 
        it that randomly succeeds or fails.</li>

        <li>contains 7 tasks that inherit from miners.</li>
      </ul>
    </div>

    <div class="slide">
      <h3 class="alwayshidden">Run the suite</h3>

      <p>Save your changes and run the suite using <samp>rose suite-run</samp>.
      The cylc gui should launch and you should see the <samp>visit_mine</samp>
      task run, then trigger the members of the <samp>MINERS</samp> family. 
      Note that some of the <samp>MINERS</samp> tasks may fail so you should 
      stop your suite using the stop button in the cylc gui in order to allow 
      it to shutdown.</p>

    </div>

    <div class="slide">
      <h2 id="example-trigger">Adding remote hosts</h2>

      <p>As you will have noticed from examining the output, your tasks have
      been run on the machine hosting the suite. This may be undesireable,
      particularly when a suite host is used by multiple users. Additionally,
      we might want to run various tasks on particular machines or run more
      computationally intensive tasks on higher power servers.</p>

      <p>We can address this by adding <samp>[[[remote]]]</samp> sections to
      the tasks in the <samp>suite.rc</samp>.</p>
    </div>

    <div class="slide">
      <h3 class="alwayshidden">Adding remote hosts (2)</h3>

      <p>Open your <samp>suite.rc</samp> file and add the following to the
      <samp>[[root]]</samp> task:</p>
      <pre class="prettyprint lang-cylc">
        [[[remote]]]
            host = "my-desktop"
</pre>

      <p>where <em>"my-desktop"</em> is the name of your desktop machine in
      quotes. This will result in all tasks running on your desktop
      machine. If you don't know the name of your desktop, type 
      <samp>hostname</samp> into your terminal.</p>
    </div>

    <div class="slide">
      <h3 class="alwayshidden">Adding remote hosts (3)</h3>

      <p>Save your changes and run your suite. Once it has completed, check the
      output from the tasks. Your should see your desktop being used as the
      task host</p>
    </div>

    <div class="slide">
      <h3 class="alwayshidden">Adding remote hosts (4)</h3>

      <p>As our suites may be run by other people, or we may run them ourselves
      on different desktops we can have rose automatically insert the name of
      the desktop being used to launch the suite (i.e. the one on which
      <samp>rose suite-run</samp> is run.</p>

      <p>To do this, change the <samp>[[[remote]]]</samp> section of
      <samp>[[root]]</samp> in the <samp>suite.rc</samp> file to look like
      this:</p>
      <pre class="prettyprint lang-cylc">
        [[[remote]]]
            host = {{ ROSE_ORIG_HOST }}
</pre>

      <p>Save your changes, run your suite and examine the output to check this
      is working as expected.</p>
    </div>

    <div class="slide">
      <h2 id="rose-host-select">Automating host selection</h2>

      <p>Rose also offers an in-built function for automatic host selection in
      the form of the <samp>rose host-select</samp> command. This will return a
      hostname from a set of pre-defined hosts in the <samp>rose.conf</samp>
      file.</p>
    </div>

    <div class="slide">
      <h3 class="alwayshidden">Automating host selection (2)</h3>

      <p>To list the hostnames available through <samp>rose host-select</samp>
      type <samp>rose config rose host-select</samp> into the command line.</p>

      <p>Depending on your rose configuration you should see something along
      the lines of:</p>
      <pre class="prettyprint lang-cylc">
default=linux-servers
group{linux-servers}=server01 server02 server03
group{hpc}=node01 node02 node03
</pre>

      <p>The <samp>default=</samp> entry identifies which group to return a
      hostname from if <samp>rose host-select</samp> is invoked without any
      arguments. Each <samp>group{groupname}</samp> entry lists the hosts from
      which one is returned when <samp>rose host-select groupname</samp> is
      run.</p>
    </div>

    <div class="slide">
      <h3 class="alwayshidden">Automating host selection (3)</h3>

      <p>In your terminal, experiment with <samp>rose host-select</samp> and 
      the names of the groups listed earlier to see what hostnames are 
      returned e.g. if you discovered a group called "linux-servers" see what
      is returned when you run <samp>rose host-select linux-servers</samp>.</p>
    </div>

    <div class="slide">
      <h3 class="alwayshidden">Automating host selection (4)</h3>

      <p>We will now implement the use of <samp>rose host-select</samp> in our
      suite by adding <samp>[[[remote]]]</samp> sections to the medium and long
      tasks in our <samp>suite.rc</samp> file as follows, replacing
      <em>groupname</em> with an appropriate group you discovered
      previously:</p>
      <pre class="prettyprint lang-cylc">
    [[medium]]
        [[[remote]]]
            host = "`rose host-select`"
        [[[environment]]]
            NUM="500"
    [[long]]
        [[[remote]]]
            host = "`rose host-select groupname`"
        [[[environment]]]
            NUM="5000"
</pre>
    </div>

    <div class="slide">
      <h3 class="alwayshidden">Automating host selection (5)</h3>

      <p>Save your changes, run the suite and view the output. You should see
      the following in the task outputs:</p>

      <ul>
        <li>The short task's host should be the machine you ran <samp>rose
        suite-run</samp> on.</li>

        <li>The medium task's host should be one of the hosts from the default
        group.</li>

        <li>The long task's host should be one of the hosts from the specified
        group.</li>
      </ul>

      <div class="slide">
        <h2 id="reference">Different triggers</h2>
        
        <p>The following types of "all" type triggers are available:</p>
        
        <ul>
            <li><samp>FAM:start-all</samp> - all the tasks in FAM have started</li> 
            <li><samp>FAM:succeed-all</samp> - all the tasks in FAM have succeeded</li> 
            <li><samp>FAM:fail-all</samp> - all the tasks in FAM have failed</li>
            <li><samp>FAM:finish-all</samp> - all the tasks in FAM have finished</li>
        </ul>
        
      </div>
      
      <div class="slide">
        <h3 class="alwayshidden">Different triggers (2)</h3>
        
        <p>The following types of "any" type triggers are available:</p>
        
        <ul>
            <li><samp>FAM:start-any</samp> - at least one task in FAM has started</li>
            <li><samp>FAM:succeed-any</samp> - at least one task in FAM has succeeded</li>
            <li><samp>FAM:fail-any</samp> - at least one task in FAM has failed</li>
            <li><samp>FAM:finish-any</samp> - at least one task in FAM has finished</li>
         </ul> 
      
      </div>


      <div class="slide">
        <h2 id="summary">Summary</h2>

        <ul>
          <li>Use the <samp>[[[remote]]]</samp> section to specify a host so
          your task doesn't run on the suite host.</li>

          <li>Use <samp>host = {{ ROSE_ORIG_HOST }}</samp> in the
          <samp>[[[remote]]]</samp> section of a task to have it run on the
          machine on which <samp>rose suite-run</samp> was invoked.</li>

          <li>Make use of <samp>rose host-select</samp> to automatically select
          a host from an appropriate group rather than hard-coding host names
          where possible.</li>
        </ul>
      </div>
    </div>
  </div>
</body>
</html>
